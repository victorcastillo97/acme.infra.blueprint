apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  namespace: demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      initContainers:
        - name: init-index
          image: busybox:1.36
          command: [ "sh", "-c" ]
          args:
            - |
              cat > /workdir/index.html <<EOF
              <!doctype html>
              <html>
                <head><meta charset="utf-8"><title>EKS Demo</title></head>
                <body style="font-family: sans-serif; padding: 2rem;">
                  <h1>EKS Demo â€” NGINX</h1>
                  <p><b>Pod:</b> $POD_NAME</p>
                  <p><b>Pod IP:</b> $POD_IP</p>
                  <p><b>Nodo:</b> $NODE_NAME</p>
                  <p>Refresca varias veces para ver el <b>balanceo</b> entre pods.</p>
                </body>
              </html>
              EOF
          env:
            - name: POD_NAME
              valueFrom: { fieldRef: { fieldPath: metadata.name } }
            - name: POD_IP
              valueFrom: { fieldRef: { fieldPath: status.podIP } }
            - name: NODE_NAME
              valueFrom: { fieldRef: { fieldPath: spec.nodeName } }
          volumeMounts:
            - name: web-content
              mountPath: /workdir
      containers:
        - name: nginx
          image: nginx:1.27-alpine
          ports:
            - name: http
              containerPort: 80
          resources:
            requests:
              cpu: "100m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"
          volumeMounts:
            - name: web-content
              mountPath: /usr/share/nginx/html
              readOnly: true
          readinessProbe:
            httpGet: { path: "/", port: 80 }
            initialDelaySeconds: 3
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: "/", port: 80 }
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: web-content
          emptyDir: {}
